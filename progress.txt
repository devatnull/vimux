## Codebase Patterns
- Simulator types live in src/lib/simulator/types.ts
- Factory functions for default state in src/lib/simulator/constants.ts
- Export all from index.ts for clean imports
- Use `npm run build` for typecheck (includes TypeScript checking)
- Pre-existing lint errors in page.tsx and components exist; ignore them
- Operator functions live in src/lib/simulator/vim/operators.ts
- When spreading state with null assignments, always add explicit `: VimState` type annotation to avoid TypeScript inference narrowing
- Text objects live in src/lib/simulator/vim/textObjects.ts; use executeTextObject(state, type, objectKey) as main entry point

---

## 2026-01-14 - US-001
Thread: http://localhost:8317/threads/T-019bbb9c-dc27-70b1-8eb4-21ec50e69963
- Implemented comprehensive type definitions for tmux and vim state
- Created src/lib/simulator/types.ts with:
  - VimMode, VimOperator, SearchDirection, FindMotion types
  - VimBuffer with marks, folds, undo/redo stacks, cursor position
  - VimState with registers (named, numbered, special), macros, jumplist, changelist, search state
  - TmuxPane with dimensions, content, scrollback, zoom state
  - TmuxWindow with panes, layout types
  - TmuxSession with windows, attached state
  - TmuxState with copy mode, prefix state, paste buffer
  - SimulatorState combining tmux and vim
- Created src/lib/simulator/constants.ts with:
  - Default settings (VimSettings)
  - Factory functions for buffers, panes, windows, sessions
  - Bracket pairs, word separators, special keys mappings
- Created src/lib/simulator/index.ts for exports
- Files changed: 3 new files in src/lib/simulator/
- **Learnings for future iterations:**
  - Existing types.ts in src/lib/ has older/simpler definitions - new simulator types are more comprehensive
  - Use createDefaultSimulatorState() to initialize full state
  - VimRegisterContent has type property ("char" | "line" | "block") for paste behavior
---

## 2026-01-14 - US-002
Thread: http://localhost:8317/threads/T-019bbba3-31c9-71e4-9948-37966264ac64
- Implemented complete vim motion engine for basic motions
- Created src/lib/simulator/vim/motions.ts with:
  - h/j/k/l character and line movement with boundary checking
  - w/W word/WORD forward motions (word = alphanumeric, WORD = whitespace-delimited)
  - b/B word/WORD backward motions
  - e/E end of word/WORD motions
  - 0/^/$ line position motions (start, first non-whitespace, end)
  - gg/G go to line motions (with optional count)
  - {/} paragraph motions (blank line separated)
  - f/F/t/T character find motions (forward/backward, on/before)
  - ;/, repeat last find motion (same/reverse direction)
  - All motions support count prefix
- Created src/lib/simulator/vim/index.ts for exports
- Updated src/lib/simulator/index.ts to export vim module
- Files changed: 3 files
- **Learnings for future iterations:**
  - Motion functions return MotionResult with optional linewise/inclusive flags for operator integration
  - lastFindMotion state tracks f/F/t/T for ; and , repetition
  - Word boundaries use WORD_SEPARATORS constant from constants.ts
  - executeMotion() is the main entry point for applying motions with count support
---

## 2026-01-14 - US-003
Thread: http://localhost:8317/threads/T-019bbba9-8793-745b-94f7-003c0442b18f
- Implemented advanced vim motions in src/lib/simulator/vim/motions.ts:
  - % (motionPercent): Bracket matching for ()[]{}
  - [[ and ]] (motionDoubleBracketBackward/Forward): Jump to function/class definitions
  - [] and ][ (motionBracketEndBackward/Forward): Jump to closing braces
  - H/M/L (motionH_screen/M_screen/L_screen): Screen-relative line navigation
  - Ctrl-d/Ctrl-u (motionCtrlD/CtrlU): Half-page scrolling with ScrollResult type
  - Ctrl-f/Ctrl-b (motionCtrlF/CtrlB): Full-page scrolling
  - n/N (motionSearchNext/Prev): Repeat search forward/backward using searchState
  - ' and ` (motionMarkLine/MarkExact): Mark navigation (line vs exact position)
  - '' (motionPreviousPosition): Jump to previous position
  - Ctrl-o/Ctrl-i (motionCtrlO/CtrlI): Jumplist navigation with position tracking
  - gi (motionGI): Go to last insert position
  - gd (motionGD): Go to local declaration (first occurrence of word)
  - * and # (motionStar/Hash): Search word under cursor forward/backward
- Added addToJumplist() helper function for jumplist management
- Extended executeMotion() switch statement with all new motion keys
- Files changed: src/lib/simulator/vim/motions.ts
- **Learnings for future iterations:**
  - ScrollResult extends MotionResult with scrollOffset for viewport management
  - Screen motions (H/M/L, Ctrl-d/u/f/b) need visibleStartLine/visibleEndLine from the UI
  - Mark navigation uses buffer.marks for local (a-z) and state.globalMarks for global (A-Z)
  - Star/Hash motions return both result and pattern for search highlighting
  - Jumplist has max 100 entries; managed via addToJumplist helper
---

## 2026-01-14 - US-004
Thread: http://localhost:8317/threads/T-019bbbaf-e594-7431-bfd1-469e62504d88
- Implemented complete vim operator system in src/lib/simulator/vim/operators.ts:
  - d{motion} deletes text covered by motion, stores in register
  - dd deletes entire line, D deletes to end of line
  - y{motion} yanks text, yy yanks line, Y yanks line
  - c{motion} changes text (delete + insert mode), cc changes line, C changes to end
  - s substitutes character (delete + insert), S substitutes line
  - x deletes char under cursor, X deletes char before cursor
  - All operators work with counts (d3w, 3dd, etc.)
  - Deleted/yanked text goes to unnamed register (") and numbered registers rotate
  - Named registers a-z work with "ayw, uppercase A-Z appends
  - p/P paste after/before cursor with register support
- Helper functions: extractText, deleteRange, getTextRange, storeInRegister
- Undo stack management with pushToUndoStack
- Changelist tracking with addToChangelist
- Updated src/lib/simulator/vim/index.ts to export operators
- Files changed: 2 files (operators.ts new, index.ts updated)
- **Learnings for future iterations:**
  - Always add explicit `: VimState` type when spreading state with null property overrides
  - OperatorResult returns { state, deletedText?, textType? } for chaining
  - executeOperator() and executeOperatorWithMotion() are main entry points
  - getRegisterContent() retrieves from any register type (named, numbered, special)
  - deleteRange handles both linewise and charwise deletions with proper cursor positioning
---

## 2026-01-14 - US-005
Thread: http://localhost:8317/threads/T-019bbbb7-f910-7378-88d8-49d010166129
- Implemented complete vim text objects in src/lib/simulator/vim/textObjects.ts:
  - iw/aw: inner/a word (aw includes trailing/leading space)
  - iW/aW: inner/a WORD (whitespace-delimited)
  - is/as: inner/a sentence (ends at .!?)
  - ip/ap: inner/a paragraph (blank line separated)
  - i"/a": inner/a double-quoted string
  - i'/a': inner/a single-quoted string
  - i`/a`: inner/a backtick string
  - i(/a( or ib/ab: inner/a parentheses block
  - i[/a[: inner/a bracket block
  - i{/a{ or iB/aB: inner/a brace block
  - i</a<: inner/a angle bracket block
  - it/at: inner/a tag block (HTML/XML)
- Updated src/lib/simulator/vim/index.ts to export textObjects
- Files changed: 2 files (textObjects.ts new, index.ts updated)
- **Learnings for future iterations:**
  - Text objects return TextObjectResult with startLine/startCol/endLine/endCol/linewise
  - executeTextObject(state, type, objectKey) is the main entry point with type "i" or "a"
  - textObjectToMotionResult() converts TextObjectResult to MotionResult for operator integration
  - Bracket matching uses depth tracking to handle nested brackets
  - Tag matching handles nested tags with same name using depth counter
---

## 2026-01-14 - US-006
Thread: http://localhost:8317/threads/T-019bbbbe-402a-741a-b654-8a534e204449
- Implemented complete vim insert mode in src/lib/simulator/vim/insertMode.ts:
  - i enters insert before cursor, a after cursor
  - I enters insert at first non-whitespace, A at end of line
  - o opens new line below and enters insert, O opens above
  - gi goes to last insert position and enters insert
  - gI enters insert at column 0
  - Escape/Ctrl-[ exits insert mode (cursor moves left one if not at start)
  - Backspace deletes character before cursor, joins lines if at start
  - Enter creates new line with proper auto-indent and smart-indent
  - Tab inserts tab or spaces based on expandtab/tabstop settings
  - Ctrl-w deletes word before cursor
  - Ctrl-u deletes to start of line
  - Ctrl-t/Ctrl-d indent/dedent current line
  - Ctrl-n/Ctrl-p trigger completion (shows message in simulator)
  - Ctrl-r{register} inserts register contents
- Updated src/lib/simulator/vim/index.ts to export insertMode
- Files changed: 2 files (insertMode.ts new, index.ts updated)
- **Learnings for future iterations:**
  - Use local getActiveBuffer wrapper that throws on missing buffer to satisfy TypeScript type narrowing
  - Insert mode tracks lastInsertedText for register storage and dot-repeat
  - insertModeStartCol tracks where insert mode started for Escape cursor positioning
  - handleInsertModeKey() is main entry point for processing keys in insert mode
  - executeInsertCommand() handles insert mode entry commands (i, a, I, A, o, O, gi, gI)
---
